#    Opentestbench : an open-source framework to assess the performances of image compression schemes
#    Copyright (C) 2015  intoPIX s.a. , Sébastien Lugan 
#    Copyright (C) 2015  Universite Catholique de Louvain, Alexandre Willème
#
#    Opentestbench is free software: you can redistribute it and/or modify
#    it under the terms of the GNU General Public License as published by
#    the Free Software Foundation, either version 3 of the License, or
#    (at your option) any later version.
#
#    This program is distributed in the hope that it will be useful,
#    but WITHOUT ANY WARRANTY; without even the implied warranty of
#    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#    GNU General Public License for more details.
#
#    You should have received a copy of the GNU General Public License
#    along with this program.  If not, see <http://www.gnu.org/licenses/>.
#    
#   For any question please contact : 
#   Alexandre Willème (alexandre.willeme@uclouvain.be)


#!/bin/bash
export LANG=C

# either singlegen multigen or errortest
test_type=multigen

#list of codecs to test 
codec=$1
path=$2

decompressed_dir_path=results/multi_generation/${codec}

if [[ ("${codec}" == "ce5_main") ]]; then
	orig_dirs=(${path}/HintergrundMusik_1920x1080_8b \
	${path}/Tools_1524x1200_8b \
	${path}/FemaleStripedHorseFly_1920x1080_8b \
	${path}/FemaleStripedHorseFly_1920x1080_8b \
	${path}/FemaleStripedHorseFly_1920x1080_8b \
	${path}/INTOPIX_ChineseEditing_3840x2160_8b \
	${path}/INTOPIX_ChineseEditing_3840x2160_8b \
	${path}/INTOPIX_ChineseEditing_3840x2160_8b \
	${path}/ARRI_Lake2_2880x1620p_24_8b_bt709_444_0040 \
	${path}/ARRI_Lake2_2880x1620p_24_8b_bt709_444_0040 \
	${path}/ARRI_Lake2_2880x1620p_24_8b_bt709_444_0040 \
	${path}/VQEG_ParkJoy_3840x2160p_50_10b_bt709_422_16022 \
	${path}/VQEG_ParkJoy_3840x2160p_50_10b_bt709_422_16022 \
	${path}/VQEG_ParkJoy_3840x2160p_50_10b_bt709_422_16022 \
	${path}/BLENDER_Sintel2_4096x1744p_24_10b_sRGB_444_00004606 \
	${path}/BLENDER_Sintel2_4096x1744p_24_10b_sRGB_444_00004606 \
	${path}/BLENDER_Sintel2_4096x1744p_24_10b_sRGB_444_00004606 \
	${path}/INTOPIX_GoogleMaps_3840x2160_8b \
	${path}/INTOPIX_GoogleMaps_3840x2160_8b \
	${path}/INTOPIX_GoogleMaps_3840x2160_8b)
	pseudo_orig_dirs=(HintergrundMusik Tools FemaleStripedHorseFly FemaleStripedHorseFly FemaleStripedHorseFly INTOPIX_ChineseEditing INTOPIX_ChineseEditing INTOPIX_ChineseEditing ARRI_Lake2 ARRI_Lake2 ARRI_Lake2 VQEG_ParkJoy VQEG_ParkJoy VQEG_ParkJoy BLENDER_Sintel2 BLENDER_Sintel2 BLENDER_Sintel2 INTOPIX_GoogleMaps INTOPIX_GoogleMaps INTOPIX_GoogleMaps)
	# list of bitrates to test  (in bpp)
	bpps=(5 6 10 11 13 3 4 5 2 3 4 3 4 5 4 5 6 3 3.5 4)
	x0pos_crop=(930 639 941 941 941 1877 1877 1877 531 531 531 800 800 800 750 750 750 2100 2100 2100)
	y0pos_crop=(122 722 281 281 281 652 652 652 900 900 900 730 730 730 760 760 760 1400 1400 1400)
	x1pos_crop=(1172 875 1154 1154 1154 2082 2082 2082 767 767 767 1030 1030 1030 1430 1430 1430 2450 2450 2450)
	y1pos_crop=(372 892 495 495 495 1062 1062 1062 1000 1000 1000 1000 1000 1000 1320 1320 1320 1750 1750 1750)
	# either RGB or YCbCr
	color_spaces=(RGB RGB RGB RGB RGB RGB RGB RGB RGB RGB RGB YCbCr YCbCr YCbCr RGB RGB RGB RGB RGB RGB)
	# either 444 or 422
	chroma_subs=(444 444 444 444 444 444 444 444 444 444 444 422 422 422 444 444 444 444 444 444)
	# either 8, 10 or 12 bits
	bit_depths=(8 8 8 8 8 8 8 8 8 8 8 10 10 10 10 10 10 8 8 8)
	# WIDTHxHEIGHT
	image_sizes=(1920x1080 1524x1200 1920x1080 1920x1080 1920x1080 3840x2160 3840x2160 3840x2160 2880x1620 2880x1620 2880x1620 3840x2160 3840x2160 3840x2160 4096x1744 4096x1744 4096x1744 3840x2160 3840x2160 3840x2160)
elif [[ ("${codec}" == "ce5_high") ]]; then
	orig_dirs=(${path}/FemaleStripedHorseFly_1920x1080_8b \
	${path}/FemaleStripedHorseFly_1920x1080_8b \
	${path}/FemaleStripedHorseFly_1920x1080_8b \
	${path}/INTOPIX_ChineseEditing_3840x2160_8b \
	${path}/INTOPIX_ChineseEditing_3840x2160_8b \
	${path}/INTOPIX_ChineseEditing_3840x2160_8b \
	${path}/ARRI_Lake2_2880x1620p_24_8b_bt709_444_0040 \
	${path}/ARRI_Lake2_2880x1620p_24_8b_bt709_444_0040 \
	${path}/ARRI_Lake2_2880x1620p_24_8b_bt709_444_0040 \
	${path}/VQEG_ParkJoy_3840x2160p_50_10b_bt709_422_16022 \
	${path}/VQEG_ParkJoy_3840x2160p_50_10b_bt709_422_16022 \
	${path}/VQEG_ParkJoy_3840x2160p_50_10b_bt709_422_16022 \
	${path}/BLENDER_Sintel2_4096x1744p_24_10b_sRGB_444_00004606 \
	${path}/BLENDER_Sintel2_4096x1744p_24_10b_sRGB_444_00004606 \
	${path}/BLENDER_Sintel2_4096x1744p_24_10b_sRGB_444_00004606 \
	${path}/INTOPIX_GoogleMaps_3840x2160_8b \
	${path}/INTOPIX_GoogleMaps_3840x2160_8b \
	${path}/INTOPIX_GoogleMaps_3840x2160_8b)
	pseudo_orig_dirs=(FemaleStripedHorseFly FemaleStripedHorseFly FemaleStripedHorseFly INTOPIX_ChineseEditing INTOPIX_ChineseEditing INTOPIX_ChineseEditing ARRI_Lake2 ARRI_Lake2 ARRI_Lake2 VQEG_ParkJoy VQEG_ParkJoy VQEG_ParkJoy BLENDER_Sintel2 BLENDER_Sintel2 BLENDER_Sintel2 INTOPIX_GoogleMaps INTOPIX_GoogleMaps INTOPIX_GoogleMaps)
	# list of bitrates to test  (in bpp)
	bpps=(9 10 12 2 3 4 2 3 4 2 3 5 3 5 6 2 3 4)
	x0pos_crop=(941 941 941 1877 1877 1877 531 531 531 800 800 800 750 750 750 2100 2100 2100)
	y0pos_crop=(281 281 281 652 652 652 900 900 900 730 730 730 760 760 760 1400 1400 1400)
	x1pos_crop=(1154 1154 1154 2082 2082 2082 767 767 767 1030 1030 1030 1430 1430 1430 2450 2450 2450)
	y1pos_crop=(495 495 495 1062 1062 1062 1000 1000 1000 1000 1000 1000 1320 1320 1320 1750 1750 1750)
	# either RGB or YCbCr
	color_spaces=(RGB RGB RGB RGB RGB RGB RGB RGB RGB YCbCr YCbCr YCbCr RGB RGB RGB RGB RGB RGB)
	# either 444 or 422
	chroma_subs=(444 444 444 444 444 444 444 444 444 422 422 422 444 444 444 444 444 444)
	# either 8, 10 or 12 bits
	bit_depths=(8 8 8 8 8 8 8 8 8 10 10 10 10 10 10 8 8 8)
	# WIDTHxHEIGHT
	image_sizes=(1920x1080 1920x1080 1920x1080 3840x2160 3840x2160 3840x2160 2880x1620 2880x1620 2880x1620 3840x2160 3840x2160 3840x2160 4096x1744 4096x1744 4096x1744 3840x2160 3840x2160 3840x2160)
elif [[ ("${codec}" == "ce5_low_logic") ]]; then
	orig_dirs=(${path}/FemaleStripedHorseFly_1920x1080_8b \
	${path}/FemaleStripedHorseFly_1920x1080_8b \
	${path}/FemaleStripedHorseFly_1920x1080_8b \
	${path}/INTOPIX_ChineseEditing_3840x2160_8b \
	${path}/INTOPIX_ChineseEditing_3840x2160_8b \
	${path}/INTOPIX_ChineseEditing_3840x2160_8b \
	${path}/ARRI_Lake2_2880x1620p_24_8b_bt709_444_0040 \
	${path}/ARRI_Lake2_2880x1620p_24_8b_bt709_444_0040 \
	${path}/ARRI_Lake2_2880x1620p_24_8b_bt709_444_0040 \
	${path}/VQEG_ParkJoy_3840x2160p_50_10b_bt709_422_16022 \
	${path}/VQEG_ParkJoy_3840x2160p_50_10b_bt709_422_16022 \
	${path}/VQEG_ParkJoy_3840x2160p_50_10b_bt709_422_16022 \
	${path}/BLENDER_Sintel2_4096x1744p_24_10b_sRGB_444_00004606 \
	${path}/BLENDER_Sintel2_4096x1744p_24_10b_sRGB_444_00004606 \
	${path}/BLENDER_Sintel2_4096x1744p_24_10b_sRGB_444_00004606 \
	${path}/INTOPIX_GoogleMaps_3840x2160_8b \
	${path}/INTOPIX_GoogleMaps_3840x2160_8b \
	${path}/INTOPIX_GoogleMaps_3840x2160_8b)
	pseudo_orig_dirs=(FemaleStripedHorseFly FemaleStripedHorseFly FemaleStripedHorseFly INTOPIX_ChineseEditing INTOPIX_ChineseEditing INTOPIX_ChineseEditing ARRI_Lake2 ARRI_Lake2 ARRI_Lake2 VQEG_ParkJoy VQEG_ParkJoy VQEG_ParkJoy BLENDER_Sintel2 BLENDER_Sintel2 BLENDER_Sintel2 INTOPIX_GoogleMaps INTOPIX_GoogleMaps INTOPIX_GoogleMaps)
	# list of bitrates to test  (in bpp)
	bpps=(10 11 13 4 5 6 2 3 4 3 4 5 4 5 7 3 4 5)
	x0pos_crop=(941 941 941 1877 1877 1877 531 531 531 800 800 800 750 750 750 1550 1550 1550)
	y0pos_crop=(281 281 281 652 652 652 900 900 900 730 730 730 760 760 760 1400 1400 1400)
	x1pos_crop=(1154 1154 1154 2082 2082 2082 767 767 767 1030 1030 1030 1430 1430 1430 2400 2400 2400)
	y1pos_crop=(495 495 495 1062 1062 1062 1000 1000 1000 1000 1000 1000 1320 1320 1320 1750 1750 1750)
	# either RGB or YCbCr
	color_spaces=(RGB RGB RGB RGB RGB RGB RGB RGB RGB YCbCr YCbCr YCbCr RGB RGB RGB RGB RGB RGB)
	# either 444 or 422
	chroma_subs=(444 444 444 444 444 444 444 444 444 422 422 422 444 444 444 444 444 444)
	# either 8, 10 or 12 bits
	bit_depths=(8 8 8 8 8 8 8 8 8 10 10 10 10 10 10 8 8 8)
	# WIDTHxHEIGHT
	image_sizes=(1920x1080 1920x1080 1920x1080 3840x2160 3840x2160 3840x2160 2880x1620 2880x1620 2880x1620 3840x2160 3840x2160 3840x2160 4096x1744 4096x1744 4096x1744 3840x2160 3840x2160 3840x2160)
elif [[ ("${codec}" == "ce5_low_memory") ]]; then
	orig_dirs=(${path}/FemaleStripedHorseFly_1920x1080_8b \
	${path}/INTOPIX_ChineseEditing_3840x2160_8b \
	${path}/ARRI_Lake2_2880x1620p_24_8b_bt709_444_0040 \
	${path}/FemaleStripedHorseFly_1920x1080_8b \
	${path}/FemaleStripedHorseFly_1920x1080_8b \
	${path}/FemaleStripedHorseFly_1920x1080_8b \
	${path}/INTOPIX_ChineseEditing_3840x2160_8b \
	${path}/INTOPIX_ChineseEditing_3840x2160_8b \
	${path}/INTOPIX_ChineseEditing_3840x2160_8b \
	${path}/ARRI_Lake2_2880x1620p_24_8b_bt709_444_0040 \
	${path}/ARRI_Lake2_2880x1620p_24_8b_bt709_444_0040 \
	${path}/ARRI_Lake2_2880x1620p_24_8b_bt709_444_0040 \
	${path}/VQEG_ParkJoy_3840x2160p_50_10b_bt709_422_16022 \
	${path}/VQEG_ParkJoy_3840x2160p_50_10b_bt709_422_16022 \
	${path}/VQEG_ParkJoy_3840x2160p_50_10b_bt709_422_16022 \
	${path}/BLENDER_Sintel2_4096x1744p_24_10b_sRGB_444_00004606 \
	${path}/BLENDER_Sintel2_4096x1744p_24_10b_sRGB_444_00004606 \
	${path}/BLENDER_Sintel2_4096x1744p_24_10b_sRGB_444_00004606 \
	${path}/INTOPIX_GoogleMaps_3840x2160_8b \
	${path}/INTOPIX_GoogleMaps_3840x2160_8b \
	${path}/INTOPIX_GoogleMaps_3840x2160_8b)
	pseudo_orig_dirs=(FemaleStripedHorseFly INTOPIX_ChineseEditing ARRI_Lake2 FemaleStripedHorseFly FemaleStripedHorseFly FemaleStripedHorseFly INTOPIX_ChineseEditing INTOPIX_ChineseEditing INTOPIX_ChineseEditing ARRI_Lake2 ARRI_Lake2 ARRI_Lake2 VQEG_ParkJoy VQEG_ParkJoy VQEG_ParkJoy BLENDER_Sintel2 BLENDER_Sintel2 BLENDER_Sintel2 INTOPIX_GoogleMaps INTOPIX_GoogleMaps INTOPIX_GoogleMaps)
	# list of bitrates to test  (in bpp)
	bpps=(4 3 2 12 13 15 6 8 9 3 4 5 3 4 5.5 4 5 7 4 5 7)
	x0pos_crop=(941 1877 531 941 941 941 1877 1877 1877 531 531 531 800 800 800 750 750 750 850 850 850)
	y0pos_crop=(281 652 900 281 281 281 652 652 652 900 900 900 730 730 730 760 760 760 1100 1100 1100)
	x1pos_crop=(1154 2082 767 1154 1154 1154 2082 2082 2082 767 767 767 1030 1030 1030 1430 1430 1430 1050 1050 1050)
	y1pos_crop=(495 1062 1000 495 495 495 1062 1062 1062 1000 1000 1000 1000 1000 1000 1320 1320 1320 1400 1400 1400)
	# either RGB or YCbCr
	color_spaces=(RGB RGB RGB RGB RGB RGB RGB RGB RGB RGB RGB RGB YCbCr YCbCr YCbCr RGB RGB RGB RGB RGB RGB)
	# either 444 or 422
	chroma_subs=(444 444 444 444 444 444 444 444 444 444 444 444 422 422 422 444 444 444 444 444 444)
	# either 8, 10 or 12 bits
	bit_depths=(8 8 8 8 8 8 8 8 8 8 8 8 10 10 10 10 10 10 8 8 8)
	# WIDTHxHEIGHT
	image_sizes=(1920x1080 3840x2160 2880x1620 1920x1080 1920x1080 1920x1080 3840x2160 3840x2160 3840x2160 2880x1620 2880x1620 2880x1620 3840x2160 3840x2160 3840x2160 4096x1744 4096x1744 4096x1744 3840x2160 3840x2160 3840x2160)
fi

niter=7
central_width=50
output_size=3840x2160
flickering_period=1
decompressed_sides=(left right)


#-----------------------------------------------------------------------------
tmpdir=/tmp/cool
source benchmark/paths.sh
rm -r ${tmpdir}
mkdir -p ${tmpdir}
for ((b=0; b<${#orig_dirs[@]}; ++b)); do
		for ((y=0; y<${#decompressed_sides[@]}; ++y)); do
					#central_width=${central_widths[$b]}
					#output_size=${output_sizes[$b]}
					#flickering_period=${flickering_periods[$b]}
					decompressed_side=${decompressed_sides[$y]}
					output_width=${output_size/x*}
					output_height=${output_size#*x}
					bpp=${bpps[$b]}
					orig_dir=${orig_dirs[$b]}
					short_name=${orig_dir##*/}
					pseudo_name=${pseudo_orig_dirs[$b]}
					decompressed_name=${short_name}_sb1_${codec}_${bpp/./_}bpp_r${niter}	
					decompressed_path=${decompressed_dir_path}/${decompressed_name}
					mkdir -p ${tmpdir}/${decompressed_name}
					echo ${decompressed_path}
					for f in $(find -L ${decompressed_path} -type f|grep -v ".txt$"|sort); do
						g=${f##*/}
						extension=${g/*.}
						name=${g/.${extension}}
						cp ${f} ${tmpdir}/${decompressed_name}/${name}_0.${extension}		
						cp ${f} ${tmpdir}/${decompressed_name}/${name}_1.${extension}
					done
					mkdir -p ${tmpdir}/${short_name}
					for f in $(find -L ${orig_dir} -type f|grep -v ".txt$"|sort); do
						g=${f##*/}
						extension=${g/*.}
						name=${g/.${extension}}
						cp ${f} ${tmpdir}/${short_name}/${name}_0.${extension}		
						cp ${f} ${tmpdir}/${short_name}/${name}_1.${extension}		
					done
					
					echo "Pre-processing step: ${test_type} codec ${codecs[$b]} bitrate ${bpp} decompressed_dirs ${decompressed_dirs[$b]}"
					bash preprocess/preprocess.sh ${test_type} ${codec} ${bpp} ${tmpdir}/${short_name}  ${tmpdir}/${decompressed_name} ${color_spaces[$b]} ${chroma_subs[$b]} ${bit_depths[$b]} ${image_sizes[$b]} ${flickering_period} ${decompressed_side} ${x0pos_crop[$b]} ${x1pos_crop[$b]} ${y0pos_crop[$b]} ${y1pos_crop[$b]} ${central_width} ${output_width} ${output_height} ${niter} ${pseudo_name}

					#testname=${short_name}_sb1_${codec}_${bpp/./_}bpp_r${niter}_preprocess_fp${flickering_period}_${decompressed_side}_crop_x0_${x0pos_crop[$b]}_x1_${x1pos_crop[$b]}_y0_${y0pos_crop[$b]}_y1_${y1pos_crop[$b]}_cw${central_width}	
					testname=${pseudo_name}_${codec}_${bpp/./_}bpp_${decompressed_side}
					still_folder=${PWD}/preprocessed_material/stills/${codec}/${testname}

					seqs_folder=${PWD}/preprocessed_material/seqs/${codec}
					mkdir -p ${seqs_folder}
					if [[ ("${extension}" == "ppm") && ("${bit_depths[$b]}" == "8") ]]; then
							ffmpeg -r 8 -s ${output_width}x${output_height} -f image2 -vcodec ppm -i ${still_folder}/${name}_%01d.${extension} -vframes 2 -vcodec rawvideo -r 8 ${seqs_folder}/${testname}_short.mov
					elif [[ ("${extension}" == "ppm") && ("${bit_depths[$b]}" == "10") ]]; then
							ffmpeg -r 8 -s ${output_width}x${output_height} -f image2 -vcodec ppm -i ${still_folder}/${name}_%01d.${extension} -vframes 2 -vframes 2 -vcodec v410 -r 8 ${seqs_folder}/${testname}_short.mov
					elif [[ ("${extension}" == "yuv") ]]; then
							#in the context of CE5 use, v410				
							#ffmpeg -r 8 -s ${output_width}x${output_height} -f image2 -vcodec rawvideo -pix_fmt yuv422p10le -i ${still_folder}/${name}_%01d.${extension} -vframes 2 -vcodec v210 -r 8 ${seqs_folder}/${testname}_short.mov
							ffmpeg -r 8 -s ${output_width}x${output_height} -f image2 -vcodec ppm -i ${still_folder}/${name}_%01d.ppm -vframes 2 -vcodec v410 -r 8 ${seqs_folder}/${testname}_short.mov
					else
							echo "This format is not supported"
					fi
					ffmpeg -f concat -i <(for i in {1..20}; do printf "file '%s'\n" ${seqs_folder}/${testname}_short.mov; done) -c copy ${seqs_folder}/${testname}.mov
					rm ${seqs_folder}/${testname}_short.mov
					rm -r ${tmpdir}
		done
done
