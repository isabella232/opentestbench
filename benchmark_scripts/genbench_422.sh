#    Opentestbench : an open-source framework to assess the performances of image compression schemes
#    Copyright (C) 2015  intoPIX s.a. , Sébastien Lugan 
#    Copyright (C) 2015  Universite Catholique de Louvain, Alexandre Willème
#
#    Opentestbench is free software: you can redistribute it and/or modify
#    it under the terms of the GNU General Public License as published by
#    the Free Software Foundation, either version 3 of the License, or
#    (at your option) any later version.
#
#    This program is distributed in the hope that it will be useful,
#    but WITHOUT ANY WARRANTY; without even the implied warranty of
#    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#    GNU General Public License for more details.
#
#    You should have received a copy of the GNU General Public License
#    along with this program.  If not, see <http://www.gnu.org/licenses/>.
#    
#   For any question please contact : 
#   Alexandre Willème (alexandre.willeme@uclouvain.be)
#   Sébastien Lugan (sebastien.lugan@uclouvain.be)

#!/bin/bash
export LANG=C

source paths.sh

function genbench
{
    testname=$1
    cust_process=$2
    bpp=$3
    srcpath=$4
    srccompapath=$5
    outpath=$6
    shift 6
    opts=$*
    mkdir ${outpath}/${testname}
    ${cust_process} ${bpp} ${srcpath} ${outpath}/${testname} ${opts}
    for f in $(find -L ${srcpath} -type f|grep -v ".txt$"|sort); do
        g=${f##*/}
        g=${g/.*}
        dst=${outpath}/${testname}/${g}.v210
        srccompa=${srccompapath}/${g}.v210
        if [ ! -f ${dst} ]; then
            echo ${g} NaN
        else   
            echo ${g} $(${V210TOOLSPATH}/v210_psnr ${srccompa} ${dst}|sed 's/.* = //;s/ .*//') 
        fi
    #   to remove the picture in the output folder
    #   rm ${dst}
    done > ${outpath}/psnr_${testname}.dat
}

if [ -z ${shortname} ]; then
  shortname=${src##*/}
fi

function codec_tc2
{
    bpp=$1
    srcpath=$2
    dstpath=$3
    geom=$4
    cfgfile=$5
    shift 5
    width=${geom/x*}
    height=${geom#*x}
    if [ -z "${cfgfile}" ]; then
        cfgfile=${TICOPATH}/configs/tico_97_422_psnr.ini
    fi
    optargs="-C ${cfgfile} -b ${bpp} -w 3840 -h 2160"
    for f in $(find -L ${srcpath} -type f|grep -v ".txt$"|sort); do
        g=${f##*/}
        g=${g/.*}
        echo $g
        if [ -f ${dstpath}/${g}.v210 ]; then
            echo "Already there!"
        else
            if [ "$(expr substr $(uname -s) 1 5)" == "Linux" ]; then
                ${TICOPATH}/bin/linux64/tco_enc_dec ${optargs} ${f} ${dstpath}/${g}.v210
            else 
                echo "These scripts only work on LINUX platforms"
            fi
        fi
    done
}

function codec_j2kull
{
    bpp=$1
    srcpath=$2
    dstpath=$3
    for f in $(find -L ${srcpath} -type f|grep -v ".txt$"|sort); do
        g=${f##*/}
        g=${g/.*}
        echo ${g}
        if [ -f ${dstpath}/${g}.v210 ]; then
            echo "Already there!"
        else
            bash j2kULL_tiled_422.sh -b ${bpp} ${f} ${dstpath}/${g}.v210
        fi
    done
}

function codec_j2kullc
{
    bpp=$1
    srcpath=$2
    dstpath=$3
    for f in $(find -L ${srcpath} -type f|grep -v ".txt$"|sort); do
        g=${f##*/}
        g=${g/.*}
        echo ${g}
        if [ -f ${dstpath}/${g}.v210 ]; then
            echo "Already there!"
        else
            bash j2kULLC_tiled_422.sh -b ${bpp} ${f} ${dstpath}/${g}.v210
        fi
    done
}

function codec_dsc12
{
    bpp=$1
    srcpath=$2
    dstpath=$3
    tmp_dir=$(mktemp -d /tmp/broadcom_XXXXX)
    tmp_cfg=${tmp_dir}/config.cfg
    tmp_lst=test_list.txt
    mkdir ${tmp_dir}/input
    if [ "$(expr substr $(uname -s) 1 5)" == "Linux" ]; then
        ln -s ${DSCPATH}/*.cfg    ${tmp_dir}  
    else 
        echo "These scripts only work on LINUX platforms"
    fi
    sed 's/12bpp/'${bpp}'bpp/' ${tmp_dir}/test.cfg > ${tmp_cfg}
    for f in $(find -L ${srcpath} -type f|grep -v ".txt$"|sort); do
        g=${f##*/}
        g=${g/.*}
        if [ -f ${dstpath}/${g}.v210 ]; then
            echo "Already there!"
        else
            ${DIFFTESTPATH}/difftest_ng --convert ${tmp_dir}/input/${g}.dpx ${f}@3840x2160x3:-{10-=1},{10-=0},{10-=2},{2-}:-{10-=0},{10-=1},{10-=0},{2-}:-{10-=2},{10-=0},{10-=1},{2-}:-{10-=0},{10-=2},{10-=0},{2-} -
        fi
    done
    pushd "${tmp_dir}"
    find input -type f > ${tmp_lst}
    if [ "$(expr substr $(uname -s) 1 5)" == "Linux" ]; then
        ${DSCPATH}/dsc -F config.cfg ${tmp_lst}
    else 
        echo "These scripts only work on LINUX platforms"
    fi
    popd
    for f in $(find ${tmp_dir} -name '*.out.dpx' -type f); do
        g=${f##*/}
        g=${g/.*}
        ${DIFFTESTPATH}/difftest_ng --convert ${dstpath}/${g}.v210@3840x2160x3:-{10-=1},{10-=0},{10-=2},{2-}:-{10-=0},{10-=1},{10-=0},{2-}:-{10-=2},{10-=0},{10-=1},{2-}:-{10-=0},{10-=2},{10-=0},{2-} ${f} -
    done
    rm -rf ${tmp_dir}
}


# usage:
#   genbench.sh codec bpp dst_dir src_dir [short_name]

codec=$1
bpp=$2
dst=$3
src=$4
srccompa=$5
shortname=$6
shift 6
opts=$*
exepath=${PWD}/../prod
  
if [ -z ${codec} ] || [ -z ${bpp} ] || [ -z ${dst} ] || [ -z ${src} ]; then
  echo "Usage: $0 codec bpp dst_dir src_dir [short_name]"
  exit 1
fi
# Usage: genbench name codec codec_opts src_dir out_dir
genbench ${codec}-${bpp}bpp_${shortname} codec_${codec} ${bpp} ${src} ${srccompa} ${dst} ${opts}
