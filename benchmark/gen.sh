#    Opentestbench : an open-source framework to assess the performances of image compression schemes
#    Copyright (C) 2015  intoPIX s.a. , Sébastien Lugan 
#    Copyright (C) 2015  Universite Catholique de Louvain, Alexandre Willème
#
#    Opentestbench is free software: you can redistribute it and/or modify
#    it under the terms of the GNU General Public License as published by
#    the Free Software Foundation, either version 3 of the License, or
#    (at your option) any later version.
#
#    This program is distributed in the hope that it will be useful,
#    but WITHOUT ANY WARRANTY; without even the implied warranty of
#    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#    GNU General Public License for more details.
#
#    You should have received a copy of the GNU General Public License
#    along with this program.  If not, see <http://www.gnu.org/licenses/>.
#    
#   For any question please contact : 
#   Alexandre Willème (alexandre.willeme@uclouvain.be)


#!/bin/bash
export LANG=C

source benchmark/paths.sh


function gen
{
	test_name=$1
	codec=$2
	bpp=$3
	src_dir=$4
	compa_dir=$5
	color_space=$6
	chroma_sub=$7
	bit_depth=$8
	image_size=$9
	output_dir=${10}
  shift 10

  mkdir -p ${output_dir}/${test_name}
	test_dir=${output_dir}/${test_name}

	if [[ ("${color_space}" == "RGB") && ("${chroma_sub}" == "444") && (("${bit_depth}" == "8") || ("${bit_depth}" == "10")) ]]; then
		extension=ppm
	elif [ ${color_space} = "YCbCr" ] && [ ${chroma_sub} = "422" ] && [ ${bit_depth} = 10 ]; then
		extension=v210
		suffixdifftest=@${image_size}x3:-{10-=1},{10-=0},{10-=2},{2-}:-{10-=0},{10-=1},{10-=0},{2-}:-{10-=2},{10-=0},{10-=1},{2-}:-{10-=0},{10-=2},{10-=0},{2-}
	fi

  bash benchmark/${codec}/${codec}.sh ${bpp} ${src_dir} ${color_space} ${chroma_sub} ${bit_depth} ${image_size} ${test_dir}

  for f in $(find -L ${src_dir} -type f|grep -v ".txt$"|sort); do
    g=${f##*/}
    name=${g/.*}
    test_file=${test_dir}/${name}.${extension}
    compa_file=${compa_dir}/${name}.${extension}
    if [ ! -f ${test_file} ]; then
      echo ${name}.${extension} NaN
    else
      result=$(${DIFFTESTPATH}/difftest_ng --psnr ${test_file}${suffixdifftest} ${compa_file}${suffixdifftest})
      result2=${result##*:}
      echo ${name}.${extension} ${result2}
    fi
#    to remove the picture in the output folder
#    rm ${test_file}
  done > ${output_dir}/psnr_${test_name}.dat
}






# usage:
#   gen.sh test_name codec bpp src_dir compa_dir color_space chroma_sub bit_depth image_size output_dir

test_name=$1
codec=$2
bpp=$3
src_dir=$4
compa_dir=$5
color_space=$6
chroma_sub=$7
bit_depth=$8
image_size=$9
output_dir=${10}
shift 10

  
if [ -z ${test_name} ] || [ -z ${codec} ] || [ -z ${bpp} ] || [ -z ${src_dir} ] || [ -z ${compa_dir} ] || [ -z ${color_space} ] || [ -z ${chroma_sub} ] || [ -z ${bit_depth} ] || [ -z ${image_size} ] || [ -z ${output_dir} ]; then
  echo "Usage: gen.sh test_name codec bpp src_dir compa_dir color_space chroma_sub bit_depth image_size output_dir"
  exit 1
fi

gen ${test_name} ${codec} ${bpp} ${src_dir} ${compa_dir} ${color_space} ${chroma_sub} ${bit_depth} ${image_size} ${output_dir}
