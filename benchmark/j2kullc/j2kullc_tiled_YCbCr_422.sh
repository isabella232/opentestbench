#    Opentestbench : an open-source framework to assess the performances of image compression schemes
#    Copyright (C) 2015  intoPIX s.a. , Sébastien Lugan 
#    Copyright (C) 2015  Universite Catholique de Louvain, Alexandre Willème
#
#    Opentestbench is free software: you can redistribute it and/or modify
#    it under the terms of the GNU General Public License as published by
#    the Free Software Foundation, either version 3 of the License, or
#    (at your option) any later version.
#
#    This program is distributed in the hope that it will be useful,
#    but WITHOUT ANY WARRANTY; without even the implied warranty of
#    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#    GNU General Public License for more details.
#
#    You should have received a copy of the GNU General Public License
#    along with this program.  If not, see <http://www.gnu.org/licenses/>.
#    
#   For any question please contact : 
#   Alexandre Willème (alexandre.willeme@uclouvain.be)

#!/bin/bash
export LANG=C

source benchmark/paths.sh

function xstr
{
  echo $(for ((i=0;i<${1};++i)); do echo -n ${2}; done)
}

function kdu_compress
{
  geom=${1}
  kinput_file_yp=${2}
  kinput_file_cb=${3}
  kinput_file_cr=${4}
  koutput_file=${5}
  rate=${6}
	bit_depth=${7}
  levels=${8}
  if [ -z ${levels} ]; then
    levels=5
  fi
  Cblk=${9}
  if [ -z ${Cblk} ]; then
    Cblk=32x32
  fi
  Cblk=${Cblk##*x},${Cblk/x*}

  Cprec=$(xstr $((${levels})) "{256,256},")"{128,128}"
  
  local width=${geom/x*}
  local height=${geom#*x}
  local width2=$((${width}/2))

	echo bit_depth ${bit_depth}

  LD_LIBRARY_PATH=${KDUPATH} ${KDUPATH}/kdu_compress \
    -i ${kinput_file_yp},${kinput_file_cb},${kinput_file_cr} -o ${koutput_file} \
    Mprecision=${bit_depth},${bit_depth},${bit_depth} Sprecision=${bit_depth},${bit_depth},${bit_depth} Ssigned=no,no,no \
    Sdims="{${height},${width}},{${height},${width2}},{${height},${width2}}" \
    Scomponents=3 Stiles="{2,8192}" ORGgen_tlm=3 ORGtparts=C Corder="{CPRL}" Clevels=${levels} \
    Cprecincts="${Cprec}" Cblk="{${Cblk}}" Creversible=no Cycc=no Cmodes="{RESET|RESTART|CAUSAL|BYPASS}" -precise Qstep=.0001 \
    -rate ${rate} -no_weights  -num_threads 0
}

function kdu_expand
{
  LD_LIBRARY_PATH=${KDUPATH} ${KDUPATH}/kdu_expand \
    -i ${1} -o ${2},${2/_y./_cb.},${2/_y./_cr.} -precise  -num_threads 0
}

function tiled_compress
{
	bpp=$1
	src_file=$2
	image_size=$3
	bit_depth=$4
	stripes_height=$5
	test_file=$6
  errorPos=${7}
  numBits=${8}
	extension=${test_file##*.}
	if [ ${errorPos} = 0 ] && [ ${numBits} = 0 ]; then
			errorTest=0
	else
			errorTest=1
	fi

  sn=${src_file##*/}  # Short name
  bn=${sn/.*}           # Base name

  width=${image_size/x*}
  height=${image_size#*x}

  # Stripes geometry
  res_full=${width}x${height}
	half_width=$(bc <<< "${width}/2")
	res_half=${half_width}x${height}
  res_yp=${width}x${stripes_height}
  res_cb=${half_width}x${stripes_height}
  res_cr=${half_width}x${stripes_height}
	tilenum=$(bc <<< "${height}/${stripes_height}")

  # J2K parameters
  cblk=1024x4
  levels=6

  # Step 1: split the image

  if [ ! -d ${TMPDIR}/t_${res_yp} ]; then
    mkdir ${TMPDIR}/t_${res_yp}
  fi
	
	Ysize=$(bc <<< "${width}*${height}*16/8")
	Csize=$(bc <<< "${width}*${height}*16/8/2")
	
	if [ $bit_depth = "10" ]; then
			format_specifier_le="@${width}x${height}x3:[6-],[10-=0]:[6-]/2x1,[10-=1]/2x1:[6-]/2x1,[10-=2]/2x1"
			format_specifier_be="@${width}x${height}x3:[6],[10=0]:[6]/2x1,[10=1]/2x1:[6]/2x1,[10=2]/2x1"
			bytes=2
	elif [ $bit_depth = "12" ]; then
			format_specifier_le="@${width}x${height}x3:[4-],[12-=0]:[4-]/2x1,[12-=1]/2x1:[4-]/2x1,[12-=2]/2x1"
			format_specifier_be="@${width}x${height}x3:[4],[12=0]:[4]/2x1,[12=1]/2x1:[4]/2x1,[12=2]/2x1"
			bytes=2
	fi
	
	${DIFFTESTPATH}/difftest_ng --convert ${TMPDIR}/inbe.raw${format_specifier_be} ${src_file}${format_specifier_le} -

	split --bytes=${Ysize} ${TMPDIR}/inbe.raw ${TMPDIR}/${bn}
	mv ${TMPDIR}/${bn}aa ${TMPDIR}/t_${res_yp}/component_y.raw
	split --bytes=${Csize} ${TMPDIR}/${bn}ab ${TMPDIR}/${bn}C
	mv ${TMPDIR}/${bn}Caa ${TMPDIR}/t_${res_yp}/component_cb.raw
	mv ${TMPDIR}/${bn}Cab ${TMPDIR}/t_${res_yp}/component_cr.raw
	rm ${TMPDIR}/${bn}ab

	sizeOfStripePerCompY=$(bc <<< "${stripes_height}*${width}*${bytes}")	
	sizeOfStripePerCompC=$(bc <<< "${stripes_height}*${half_width}*${bytes}")	
	split --bytes=${sizeOfStripePerCompY} --suffix-length=3 --additional-suffix=".raw" --numeric-suffixes ${TMPDIR}/t_${res_yp}/component_y.raw ${TMPDIR}/t_${res_yp}/${bn}_y_
	split --bytes=${sizeOfStripePerCompC} --suffix-length=3 --additional-suffix=".raw" --numeric-suffixes ${TMPDIR}/t_${res_yp}/component_cb.raw ${TMPDIR}/t_${res_yp}/${bn}_cb_
	split --bytes=${sizeOfStripePerCompC} --suffix-length=3 --additional-suffix=".raw" --numeric-suffixes ${TMPDIR}/t_${res_yp}/component_cr.raw ${TMPDIR}/t_${res_yp}/${bn}_cr_

  # Step 2: compress the individual tiles

  dirname=${TMPDIR}/r_${bpp}_${cblk}_${res_yp}
  if [ ! -d ${dirname} ]; then mkdir ${dirname}; fi
  for f in "${TMPDIR}/t_${res_yp}/${bn}_y"_*.raw; do
    out=${dirname}/kdu_${f##*/}
    out=${out/_y_/_}
    out=${out/.raw}.j2k
		stripeFileSize=$(wc -c < ${f})
		numLines=$(bc <<< "${stripeFileSize}/${width}/${bytes}")
		kdu_compress ${width}x${numLines} ${f} ${f/_y_/_cb_} ${f/_y_/_cr_} ${out} ${bpp} ${bit_depth} ${levels} ${cblk} # 2>&1 > /dev/null
    wait
  done

  # Step 3: uncompress the individual tiles
  let i=0
  posError=$(bc <<< "$errorPos*($tilenum)")
	realSize=0
  for f in "${dirname}/kdu_${bn}"_*.j2k; do
		if [ ${errorTest} = 1 ]; then
			let lowBound=i
		  let highBound=i+1
	 #   echo OOK $lowBound $highBound OK
	 #   echo $posError
		  flagIn=$(bc <<< "scale=4; $posError>$lowBound && $posError<$highBound")
	    echo $flagIn
		  if [ $flagIn = 1 ]; then
	 #       echo temper $f
		      insidePos=$(bc <<< "scale=4; ($posError-$lowBound)") 
		      ${EIPATH}/error_insertion1b "${f}" ${insidePos} ${numBits}
		  fi
			let i=i+1
		fi
		currentSize=$(wc -c < "${f}")
		realSize=$(bc <<< "${realSize}+${currentSize}")
    kdu_expand "${f}" "${f/.j2k}_y.raw" #2>&1 > /dev/null
    wait
  done

  # Step 4: recombine the individual tiles

cat ${dirname}/kdu_${bn}_*_y.raw > ${TMPDIR}/almostcompleteY.raw
cat ${dirname}/kdu_${bn}_*_cb.raw > ${TMPDIR}/almostcompleteCb.raw
cat ${dirname}/kdu_${bn}_*_cr.raw > ${TMPDIR}/almostcompleteCr.raw
cat ${TMPDIR}/almostcompleteY.raw ${TMPDIR}/almostcompleteCb.raw ${TMPDIR}/almostcompleteCr.raw > ${TMPDIR}/almostcomplete.raw

${DIFFTESTPATH}/difftest_ng --convert ${test_file/.*}.raw${format_specifier_le} ${TMPDIR}/almostcomplete.raw${format_specifier_be} -
targetSize=$(bc <<< "${bpp}*${width}*${height}/8")
mv ${test_file/.*}.raw ${test_file/.*}_sc${realSize}x${targetSize}.${extension}
}




# usage:
#   j2kullc_tiled_YCbCr_422.sh bpp src_file image_size bit_depth stripes_height test_file (errorPos) (numBits)

bpp=$1
src_file=$2
image_size=$3
bit_depth=$4
stripes_height=$5
test_file=$6
errorPos=$7
numBits=$8
shift 8

if [ -z ${bpp} ] || [ -z ${src_file} ] || [ -z ${image_size} ] || [ -z ${stripes_height} ] || [ -z ${bit_depth} ]|| [ -z ${test_file} ]; then
  echo "Usage: j2kullc_tiled_YCbCr_422.sh bpp src_file image_size bit_depth stripes_height test_file (errorPos) (numBits)"
  exit 1
fi

if [ -z ${errorPos} ] && [ -z ${numBits} ]; then
	errorPos=0
	numBits=0
fi

TMPDIR=$(mktemp -d /tmp/j2ktiler_XXXX)
tiled_compress ${bpp} ${src_file} ${image_size} ${bit_depth} ${stripes_height} ${test_file} ${errorPos} ${numBits}
rm -rf ${TMPDIR}
